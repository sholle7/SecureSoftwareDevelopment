<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Car Details</title>
</head>
<body>

<span sec:authorize="isAuthenticated()"
      th:text="${#authentication.principal.username}"
      id="currentUser"
      hidden></span>

<div layout:fragment="content">
    <h1>Car details</h1>
    <div class="row">
        <div class="col-6">
            <form method="POST" th:action="@{/cars/__${car.id}__}">
                <div class="form-group">
                    <label for="model">Model</label>
                    <input type="text" id="model" name="model" class="form-control" th:value="${car.model}">
                </div>
                <div class="form-group">
                    <label for="manufacturer">Manufacturer</label>
                    <input type="text" id="manufacturer" name="manufacturer" class="form-control"
                           th:value="${car.manufacturer}">
                </div>
                <div class="form-group">
                    <label for="price">Price</label>
                    <input type="text" id="price" name="price" class="form-control" th:value="${car.price}">
                </div>
                <div class="form-group">
                    <label for="wholesalePrice">Wholesale Price</label>
                    <input type="text" id="wholesalePrice" name="wholesalePrice" class="form-control"
                           th:value="${car.wholesalePrice}">
                </div>
                <div>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>

        <div class="col-5 d-flex flex-column align-items-start ml-5">
            <img th:if="${car.imagePath}"
                 th:src="@{/images/__${car.imagePath}__}"
                 alt="Car image"
                 class="img-fluid border mb-2"
                 style="max-height: 300px; object-fit: contain;">

            <a th:if="${car.imagePath}"
               th:href="@{/download(filename=${car.imagePath})}"
               class="btn btn-secondary btn-sm mt-2">
                Download Image
            </a>

            <div th:unless="${car.imagePath}" class="text-muted">
                No image available
            </div>
        </div>
    </div>

    <div sec:authorize="hasAuthority('CAN_BUY_CAR')" class="mt-2 mb-2">
        <a th:href="@{'/buy-car/' + ${car.id}}">Buy Car</a>
    </div>

    <h2 id="car-comments">Car comments</h2>

    <div class="form-group" th:each="comment, iter : ${comments}">
        <b th:text="${comment.personName}"></b>
        <div class="form-control mb-1" th:id="'commentDisplay-' + ${iter.index}" th:text="${comment.comment}"></div>
        <textarea class="form-control mb-1" th:id="'commentEdit-' + ${iter.index}" style="display:none;"></textarea>

        <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                th:if="${comment.userId == currentUserId}"
                th:data-comment-id="${comment.commentId}"
                th:data-index="${iter.index}">
            Edit
        </button>
        <button type="button" class="btn btn-sm btn-success save-btn"
                th:if="${comment.userId == currentUserId}"
                th:data-comment-id="${comment.commentId}"
                th:data-index="${iter.index}"
                style="display:none;">
            Save
        </button>
    </div>

    <div class="form-group">
        <label for="addComment">Add comment</label>
        <textarea class="form-control" id="addComment" rows="3" placeholder="Comment..."></textarea>
        <button id="createComment" class="btn btn-primary mt-2">Create comment</button>
    </div>

    <script th:inline="javascript">
        const carId = [[${car.id}]];
        const currentUserId = [[${currentUserId}]];
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Create comment
            document.getElementById('createComment')?.addEventListener('click', function () {
                const text = document.getElementById('addComment').value.trim();
                if (!text) return;
                fetch('/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ carId: carId, comment: text })
                }).then(() => window.location.reload());
            });

            // Edit button click
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = this.dataset.index;
                    const display = document.getElementById(`commentDisplay-${index}`);
                    const textarea = document.getElementById(`commentEdit-${index}`);
                    const saveBtn = document.querySelector(`.save-btn[data-index="${index}"]`);

                    textarea.value = display.innerText;
                    display.style.display = 'none';
                    textarea.style.display = 'block';
                    this.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                });
            });

            // Save button click
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = this.dataset.index;
                    const commentId = this.dataset.commentId;
                    const textarea = document.getElementById(`commentEdit-${index}`);
                    const newText = textarea.value.trim();

                    if (!newText) return;

                    fetch('/comments/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: commentId,
                            comment: newText,
                            userId: currentUserId
                        })
                    }).then(response => {
                        if (response.ok) {
                            const display = document.getElementById(`commentDisplay-${index}`);
                            display.innerText = newText;
                            display.style.display = 'block';
                            textarea.style.display = 'none';
                            document.querySelector(`.edit-btn[data-index="${index}"]`).style.display = 'inline-block';
                            this.style.display = 'none';
                        } else {
                            alert('Failed to update comment');
                        }
                    });
                });
            });
        });
    </script>
</div>
</body>
</html>
